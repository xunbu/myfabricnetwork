# 部署链码(my network)

## 设置环境变量

```bash
cd ~/fabric/mynetwork
export PATH=$PATH:${PWD}/bin
export FABRIC_CFG_PATH=${PWD}/config/
export CORE_PEER_TLS_ENABLED=true
```

## 打包智能合约

```bash
export CC_NAME=basic
export CC_VERSION=1.0
#CC_LABEL为"链码名_版本号"
export CC_LABEL=${CC_NAME}_${CC_VERSION}
peer lifecycle chaincode package $CC_NAME.tar.gz --path ./chaincode/basicChainCode --lang golang --label $CC_LABEL
```

## 安装链码(在org1组织中)

```bash
# 设置org1环境变量
export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_LOCALMSPID="Org1MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/guolong.com/peers/peer0.guolong.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/guolong.com/users/Admin@guolong.com/msp
export CORE_PEER_ADDRESS=localhost:7051
#安装链码
peer lifecycle chaincode install ${CC_NAME}.tar.gz
#查询链码安装信息获取链码包id
peer lifecycle chaincode queryinstalled
#导出packageID
CC_PACKAGE_ID=$(peer lifecycle chaincode queryinstalled | grep "$CC_LABEL" | awk -F'Package ID: ' '{print $2}' | awk -F', ' '{print $1}')

```

> 如果是升级链码，可以从下面的代码中获取已部署链码的sequence

```bash
export CC_SEQ=$(($(peer lifecycle chaincode querycommitted --channelID mychannel --name $CC_NAME --output json 2>/dev/null | jq -r '.sequence')+1)) || export CC_SEQ=1

```

## 链码审批（在org1组织中）

```bash
#链码审批(链码包的名称在这里由--name指定)
peer lifecycle chaincode approveformyorg -o localhost:7050 --ordererTLSHostnameOverride orderer.guolong.com --channelID mychannel --name $CC_NAME --version $CC_VERSION --package-id $CC_PACKAGE_ID --sequence ${CC_SEQ:-1} --tls --cafile "${PWD}/organizations/ordererOrganizations/guolong.com/orderers/orderer.guolong.com/msp/tlscacerts/tlsca.guolong.com-cert.pem"
#查看哪些组织批准了该链码
peer lifecycle chaincode checkcommitreadiness --channelID mychannel --name $CC_NAME --version $CC_VERSION --sequence ${CC_SEQ:-1} --tls --cafile "${PWD}/organizations/ordererOrganizations/guolong.com/orderers/orderer.guolong.com/msp/tlscacerts/tlsca.guolong.com-cert.pem" --output json
```

## 提交链码至通道

```bash
#提交链码，注意这里有多少个组织审批就要携带多少个peerAddresses/tlsRootCertFiles
peer lifecycle chaincode commit -o localhost:7050 --ordererTLSHostnameOverride orderer.guolong.com --channelID mychannel --name $CC_NAME --version $CC_VERSION --sequence $CC_SEQ --tls --cafile "${PWD}/organizations/ordererOrganizations/guolong.com/orderers/orderer.guolong.com/msp/tlscacerts/tlsca.guolong.com-cert.pem" --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/guolong.com/peers/peer0.guolong.com/tls/ca.crt"
```

## 检查链码定义信息

```bash
peer lifecycle chaincode querycommitted --channelID mychannel --name $CC_NAME
```

## 通过CLI调用链码

```bash
# invoke
peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.guolong.com --tls --cafile "${PWD}/organizations/ordererOrganizations/guolong.com/orderers/orderer.guolong.com/msp/tlscacerts/tlsca.guolong.com-cert.pem" -C mychannel -n $CC_NAME --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/guolong.com/peers/peer0.guolong.com/tls/ca.crt" -c '{"function":"PutString","Args":[]}'

# query
peer chaincode query -C mychannel -n $CC_NAME -c '{"Args":["QueryByKey","a"]}'
```

## discover
```bash
discover --peerTLSCA ~/fabric/mynetwork/organizations/peerOrganizations/guolong.com/users/Admin@guolong.com/tls/ca.crt --userKey ~/fabric/mynetwork/organizations/peerOrganizations/guolong.com/users/Admin@guolong.com/msp/keystore/priv_sk --userCert ~/fabric/mynetwork/organizations/peerOrganizations/guolong.com/users/Admin@guolong.com/msp/cacerts/ca.guolong.com-cert.pem --MSP Org1MSP --tlsCert ~/fabric/mynetwork/organizations/peerOrganizations/guolong.com/users/Admin@guolong.com/tls/client.crt --tlsKey ~/fabric/mynetwork/organizations/peerOrganizations/guolong.com/users/Admin@guolong.com/tls/client.key peers --server peer0.guolong.com:7051
```