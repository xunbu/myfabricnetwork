<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>区块链浏览器</title>
    <!-- 引入Chart.js用于绘制CPU使用率图表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {

            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }
        
        .logo-icon {
            margin-right: 10px;
            font-size: 2rem;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 20px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover, nav ul li a.active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .dashboard {
            padding: 2rem 0;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #1a237e;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a237e;
        }
        
        .blocks-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        
        .blocks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .pagination {
            display: flex;
            align-items: center;
        }
        
        .pagination button {
            background: #1a237e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #283593;
        }
        
        .pagination button:disabled {
            background: #9fa8da;
            cursor: not-allowed;
        }
        
        .blocks-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .blocks-table th {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #e0e0e0;
            color: #666;
            font-weight: 600;
        }
        
        .blocks-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .block-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .block-row:hover {
            background-color: #f5f7fa;
        }
        
        .block-hash {
            font-family: monospace;
            color: #1a237e;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .block-number {
            font-weight: 600;
            color: #1a237e;
        }
        
        .tx-count {
            text-align: center;
            background: #e8eaf6;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .timestamp {
            color: #666;
            font-size: 0.9rem;
        }
        
        footer {
            background: #1a237e;
            color: white;
            text-align: center;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }
        
        /* 区块详情页面样式 */
        .block-detail {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            background: #e0e0e0;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 1.5rem;
            transition: background-color 0.3s;
        }
        
        .back-button:hover {
            background: #d0d0d0;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .detail-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .detail-title {
            font-size: 1rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            word-break: break-all;
        }
        
        .hash-value {
            font-family: monospace;
            background: #f5f5f5;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
        }
        
        .transactions-section {
            margin-top: 2rem;
        }
        
        .transaction-list {
            list-style: none;
        }
        
        .transaction-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        
        .transaction-item:hover {
            background: #f5f7fa;
        }
        
        .transaction-id {
            font-family: monospace;
            color: #1a237e;
            font-weight: 600;
        }
        
        /* 节点监控页面样式 */
        .nodes-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        
        .node-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .node-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .node-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .node-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a237e;
            margin-bottom: 1rem;
        }
        
        .cpu-usage {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .cpu-low { color: #4caf50; }
        .cpu-medium { color: #ff9800; }
        .cpu-high { color: #f44336; }
        
        .cpu-chart-container {
            height: 200px;
            margin-top: 1rem;
        }
        
        .refresh-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .refresh-button {
            background: #1a237e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .refresh-button:hover {
            background: #283593;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            nav ul {
                margin-top: 1rem;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .blocks-table {
                display: block;
                overflow-x: auto;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .node-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 主页 -->
    <div id="home-page">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">⛓️</span>
                        <span>区块链浏览器</span>
                    </div>
                    <nav>
                        <ul>
                            <li><a href="#" class="nav-link active" data-page="home">首页</a></li>
                            <li><a href="#" class="nav-link" data-page="nodes">节点监控</a></li>
                            <li><a href="#">交易</a></li>
                            <li><a href="#">链码</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </header>

        <main class="container">
            <section class="dashboard">
                <h2 class="section-title">区块链概览</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">区块高度</div>
                        <div class="stat-value" id="blockHeight">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">交易总数</div>
                        <div class="stat-value" id="totalTransactionCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">组织数量</div>
                        <div class="stat-value" id="orgCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">链码数量</div>
                        <div class="stat-value" id="chainCodeCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">节点数量</div>
                        <div class="stat-value" id="nodeCount">0</div>
                    </div>
                </div>
                
                <div class="blocks-section">
                    <div class="blocks-header">
                        <h2 class="section-title">最新区块</h2>
                        <div class="pagination">
                            <button id="prevPage" disabled>上一页</button>
                            <span id="pageInfo">第 1 页</span>
                            <button id="nextPage">下一页</button>
                        </div>
                    </div>
                    
                    <table class="blocks-table">
                        <thead>
                            <tr>
                                <th>区块高度</th>
                                <th>区块哈希</th>
                                <th>交易数量</th>
                                <th>时间戳</th>
                                <th>大小</th>
                            </tr>
                        </thead>
                        <tbody id="blocksTableBody">
                            <!-- 区块数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <footer>
            <div class="container">
                <p>区块链浏览器 &copy; 2025</p>
            </div>
        </footer>
    </div>

    <!-- 区块详情页面（初始隐藏） -->
    <div id="block-detail-page" style="display: none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">⛓️</span>
                        <span>区块详情</span>
                    </div>
                    <nav>
                        <ul>
                            <li><a href="#" id="back-to-home">返回首页</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </header>

        <main class="container">
            <button class="back-button" id="back-button">
                ← 返回区块列表
            </button>
            
            <div class="block-detail">
                <h2 class="section-title">区块信息</h2>
                
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-title">区块高度</div>
                        <div class="detail-value" id="detail-blockNumber">0</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">区块哈希</div>
                        <div class="detail-value">
                            <span class="hash-value" id="detail-blockHash">0x0000...</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">前一个区块哈希</div>
                        <div class="detail-value">
                            <span class="hash-value" id="detail-previousHash">0x0000...</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">Merkle根</div>
                        <div class="detail-value">
                            <span class="hash-value" id="detail-dataHash">0x0000...</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">交易数量</div>
                        <div class="detail-value" id="detail-txCount">0</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">区块大小</div>
                        <div class="detail-value" id="detail-blockSize">0 bytes</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">时间戳</div>
                        <div class="detail-value" id="detail-timestamp">-</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">通道ID</div>
                        <div class="detail-value" id="detail-channelId">-</div>
                    </div>
                </div>
                
                <div class="transactions-section">
                    <h2 class="section-title">交易列表</h2>
                    <ul class="transaction-list" id="transactionList">
                        <!-- 交易数据将通过JavaScript动态加载 -->
                    </ul>
                </div>
            </div>
        </main>

        <footer>
            <div class="container">
                <p>区块链浏览器 &copy; 2023 - 基于Hyperledger Fabric</p>
            </div>
        </footer>
    </div>

    <!-- 节点监控页面（初始隐藏） -->
    <div id="nodes-page" style="display: none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">⛓️</span>
                        <span>节点监控</span>
                    </div>
                    <nav>
                        <ul>
                            <li><a href="#" class="nav-link" data-page="home">返回首页</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </header>

        <main class="container">
            <section class="dashboard">
                <h2 class="section-title">节点CPU使用率监控</h2>
                
                <div class="refresh-controls">
                    <div>
                        <span>时间范围: </span>
                        <label><input type="radio" name="timeRange" value="1" checked> 1分钟</label>
                        <label><input type="radio" name="timeRange" value="5"> 5分钟</label>
                        <label><input type="radio" name="timeRange" value="30"> 30分钟</label>
                    </div>
                    <div>
                        <span>自动刷新: </span>
                        <label><input type="radio" name="refresh" value="5" checked> 5秒</label>
                        <label><input type="radio" name="refresh" value="10"> 10秒</label>
                        <label><input type="radio" name="refresh" value="30"> 30秒</label>
                        <label><input type="radio" name="refresh" value="0"> 关闭</label>
                    </div>
                    <button class="refresh-button" id="manualRefresh">手动刷新</button>
                </div>
                
                <div class="nodes-section">
                    <div class="node-cards" id="nodeCards">
                        <!-- 节点数据将通过JavaScript动态加载 -->
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <div class="container">
                <p>区块链浏览器 &copy; 2025</p>
            </div>
        </footer>
    </div>

    <script>
        // 全局变量
        let currentPage = 0;
        const pageSize = 10;
        let blockHeight = 0;
        let cpuCharts = {};
        let refreshInterval = null;
        let currentRefreshRate = 5; // 默认5秒刷新
        let currentTimeRange = 1; // 默认1分钟

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载概览数据
            loadOverviewData();
            
            // 加载区块列表
            loadBlocks(currentPage, pageSize);
            
            // 绑定事件监听器
            document.getElementById('prevPage').addEventListener('click', function() {
                if (currentPage > 0) {
                    currentPage--;
                    loadBlocks(currentPage, pageSize);
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', function() {
                if ((currentPage + 1) * pageSize < blockHeight) {
                    currentPage++;
                    loadBlocks(currentPage, pageSize);
                }
            });
            
            document.getElementById('back-button').addEventListener('click', function() {
                showHomePage();
            });
            
            document.getElementById('back-to-home').addEventListener('click', function(e) {
                e.preventDefault();
                showHomePage();
            });
            
            // 导航链接事件
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    showPage(page);
                });
            });
            
            // 手动刷新按钮
            document.getElementById('manualRefresh').addEventListener('click', function() {
                loadCPUData();
            });
            
            // 自动刷新设置
            document.querySelectorAll('input[name="refresh"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentRefreshRate = parseInt(this.value);
                    setupAutoRefresh();
                });
            });

            // 时间范围选择
            document.querySelectorAll('input[name="timeRange"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentTimeRange = parseInt(this.value);
                    loadCPUData(); // 使用新范围重新加载数据
                });
            });
            
            // 初始化自动刷新
            setupAutoRefresh();
        });

        // 设置自动刷新
        function setupAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            
            if (currentRefreshRate > 0) {
                refreshInterval = setInterval(() => {
                    if (document.getElementById('nodes-page').style.display !== 'none') {
                        loadCPUData();
                    }
                }, currentRefreshRate * 1000);
            }
        }

        // 显示指定页面
        function showPage(page) {
            // 隐藏所有页面
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('block-detail-page').style.display = 'none';
            document.getElementById('nodes-page').style.display = 'none';
            
            // 更新导航激活状态
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // 显示目标页面
            if (page === 'home') {
                document.getElementById('home-page').style.display = 'block';
                document.querySelector('.nav-link[data-page="home"]').classList.add('active');
            } else if (page === 'nodes') {
                document.getElementById('nodes-page').style.display = 'block';
                document.querySelector('.nav-link[data-page="nodes"]').classList.add('active');
                loadCPUData();
            }
        }

        // 加载概览数据
        async function loadOverviewData() {
            try {
                const response = await fetch('/valuechain');
                const data = await response.json();
                
                document.getElementById('blockHeight').textContent = data.blockHeight;
                document.getElementById('totalTransactionCount').textContent = data.totalTransactionCount;
                document.getElementById('orgCount').textContent = data.orgCount;
                document.getElementById('chainCodeCount').textContent = data.chainCodeCount;
                document.getElementById('nodeCount').textContent = data.nodeCount;
                
                blockHeight = data.blockHeight;
            } catch (error) {
                console.error('加载概览数据失败:', error);
            }
        }

        // 加载区块列表
        async function loadBlocks(pageNum, pageSize) {
            try {
                const response = await fetch(`/valuechain/getBlockByPage?pageNum=${pageNum}&pageSize=${pageSize}`);
                const blocks = await response.json();
                
                const tableBody = document.getElementById('blocksTableBody');
                tableBody.innerHTML = '';
                
                blocks.forEach(block => {
                    const row = document.createElement('tr');
                    row.className = 'block-row';
                    row.setAttribute('data-block-num', block.blockNumber);
                    
                    // 格式化时间戳
                    const timestamp = new Date(block.timestamp).toLocaleString();
                    
                    row.innerHTML = `
                        <td class="block-number">${block.blockNumber}</td>
                        <td class="block-hash" title="${block.blockHash}">${block.blockHash.substring(0, 20)}...</td>
                        <td><span class="tx-count">${block.txCount}</span></td>
                        <td class="timestamp">${timestamp}</td>
                        <td>${formatBytes(block.blockSize)}</td>
                    `;
                    
                    // 添加点击事件
                    row.addEventListener('click', function() {
                        showBlockDetail(block.blockNumber);
                    });
                    
                    tableBody.appendChild(row);
                });
                
                // 更新分页信息
                document.getElementById('pageInfo').textContent = `第 ${pageNum + 1} 页`;
                document.getElementById('prevPage').disabled = pageNum === 0;
                document.getElementById('nextPage').disabled = (pageNum + 1) * pageSize >= blockHeight;
            } catch (error) {
                console.error('加载区块列表失败:', error);
            }
        }

        // 显示区块详情
        async function showBlockDetail(blockNum) {
            try {
                const response = await fetch(`/valuechain/getBlockByNum?blockNum=${blockNum}`);
                const block = await response.json();
                
                // 填充区块详情数据
                document.getElementById('detail-blockNumber').textContent = block.blockNumber;
                document.getElementById('detail-blockHash').textContent = block.blockHash;
                document.getElementById('detail-previousHash').textContent = block.previousHash;
                document.getElementById('detail-dataHash').textContent = block.dataHash;
                document.getElementById('detail-txCount').textContent = block.txCount;
                document.getElementById('detail-blockSize').textContent = formatBytes(block.blockSize);
                document.getElementById('detail-timestamp').textContent = new Date(block.timestamp).toLocaleString();
                document.getElementById('detail-channelId').textContent = block.channelId;
                
                // 填充交易列表
                const transactionList = document.getElementById('transactionList');
                transactionList.innerHTML = '';
                
                if (block.txIds && block.txIds.length > 0) {
                    block.txIds.forEach(txId => {
                        const li = document.createElement('li');
                        li.className = 'transaction-item';
                        li.innerHTML = `<span class="transaction-id">${txId}</span>`;
                        transactionList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.className = 'transaction-item';
                    li.textContent = '此区块没有交易';
                    transactionList.appendChild(li);
                }
                
                // 显示详情页面
                showBlockDetailPage();
            } catch (error) {
                console.error('加载区块详情失败:', error);
            }
        }

        // 加载CPU使用率数据
        async function loadCPUData() {
            try {
                const response = await fetch('/valuechain/getCpuHistory');
                const cpuData = await response.json();
                
                const nodeCards = document.getElementById('nodeCards');
                nodeCards.innerHTML = '';

                const now = Date.now();
                const startTime = now - (currentTimeRange * 60 * 1000);
                
                // 处理每个节点的数据
                Object.keys(cpuData).forEach(nodeName => {
                    const nodeData = cpuData[nodeName];
                    if (nodeData.length === 0) return;
                    
                    // 过滤数据以匹配所选时间范围
                    const filteredData = nodeData.filter(d => new Date(d.Timestamp).getTime() >= startTime);

                    // 获取最新的CPU使用率（来自未经过滤的数据）
                    const latestData = nodeData[nodeData.length - 1];
                    const cpuUsage = latestData.CPUUsage.toFixed(2);
                    
                    // 根据CPU使用率设置颜色
                    let cpuClass = 'cpu-low';
                    if (cpuUsage > 50) cpuClass = 'cpu-medium'; // 调整阈值以获得更好的可视化效果
                    if (cpuUsage > 80) cpuClass = 'cpu-high';
                    
                    // 创建节点卡片
                    const nodeCard = document.createElement('div');
                    nodeCard.className = 'node-card';
                    nodeCard.innerHTML = `
                        <div class="node-name">${nodeName}</div>
                        <div class="cpu-usage ${cpuClass}">${cpuUsage}%</div>
                        <div>最新更新时间: ${new Date(latestData.Timestamp).toLocaleString()}</div>
                        <div class="cpu-chart-container">
                            <canvas id="chart-${nodeName}"></canvas>
                        </div>
                    `;
                    
                    nodeCards.appendChild(nodeCard);
                    
                    // 使用过滤后的数据创建图表
                    createCPUChart(nodeName, filteredData);
                });
            } catch (error) {
                console.error('加载CPU数据失败:', error);
                document.getElementById('nodeCards').innerHTML = '<p>无法加载节点数据，请确保监控服务正在运行。</p>';
            }
        }

        // 创建CPU使用率图表
        function createCPUChart(nodeName, dataToDisplay) {
            const ctx = document.getElementById(`chart-${nodeName}`).getContext('2d');
            
            // 准备图表数据
            const labels = dataToDisplay.map(data => 
                new Date(data.Timestamp).toLocaleTimeString()
            );
            const data = dataToDisplay.map(data => data.CPUUsage.toFixed(2));
            
            // 如果已存在图表，先销毁
            if (cpuCharts[nodeName]) {
                cpuCharts[nodeName].destroy();
            }
            
            // 创建新图表
            cpuCharts[nodeName] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'CPU使用率 (%)',
                        data: data,
                        borderColor: '#1a237e',
                        backgroundColor: 'rgba(26, 35, 126, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: dataToDisplay.length < 50 ? 3 : 0, // 点太多时隐藏点
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                // 自动跳过标签以避免重叠
                                autoSkip: true,
                                maxTicksLimit: 10 
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // 显示主页
        function showHomePage() {
            document.getElementById('home-page').style.display = 'block';
            document.getElementById('block-detail-page').style.display = 'none';
            document.getElementById('nodes-page').style.display = 'none';
            
            // 更新导航激活状态
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector('.nav-link[data-page="home"]').classList.add('active');
        }

        // 显示区块详情页面
        function showBlockDetailPage() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('block-detail-page').style.display = 'block';
            document.getElementById('nodes-page').style.display = 'none';
        }

        // 格式化字节大小
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>