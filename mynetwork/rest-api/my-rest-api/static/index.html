<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>区块链浏览器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }
        
        .logo-icon {
            margin-right: 10px;
            font-size: 2rem;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 20px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .dashboard {
            padding: 2rem 0;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #1a237e;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a237e;
        }
        
        .blocks-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        
        .blocks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .pagination {
            display: flex;
            align-items: center;
        }
        
        .pagination button {
            background: #1a237e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #283593;
        }
        
        .pagination button:disabled {
            background: #9fa8da;
            cursor: not-allowed;
        }
        
        .blocks-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .blocks-table th {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #e0e0e0;
            color: #666;
            font-weight: 600;
        }
        
        .blocks-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .block-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .block-row:hover {
            background-color: #f5f7fa;
        }
        
        .block-hash {
            font-family: monospace;
            color: #1a237e;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .block-number {
            font-weight: 600;
            color: #1a237e;
        }
        
        .tx-count {
            text-align: center;
            background: #e8eaf6;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .timestamp {
            color: #666;
            font-size: 0.9rem;
        }
        
        footer {
            background: #1a237e;
            color: white;
            text-align: center;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }
        
        /* 区块详情页面样式 */
        .block-detail {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            background: #e0e0e0;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 1.5rem;
            transition: background-color 0.3s;
        }
        
        .back-button:hover {
            background: #d0d0d0;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .detail-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .detail-title {
            font-size: 1rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            word-break: break-all;
        }
        
        .hash-value {
            font-family: monospace;
            background: #f5f5f5;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
        }
        
        .transactions-section {
            margin-top: 2rem;
        }
        
        .transaction-list {
            list-style: none;
        }
        
        .transaction-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        
        .transaction-item:hover {
            background: #f5f7fa;
        }
        
        .transaction-id {
            font-family: monospace;
            color: #1a237e;
            font-weight: 600;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            nav ul {
                margin-top: 1rem;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .blocks-table {
                display: block;
                overflow-x: auto;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 主页 -->
    <div id="home-page">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">⛓️</span>
                        <span>区块链浏览器</span>
                    </div>
                    <nav>
                        <ul>
                            <li><a href="#" class="active">首页</a></li>
                            <li><a href="#">交易</a></li>
                            <li><a href="#">链码</a></li>
                            <li><a href="#">节点</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </header>

        <main class="container">
            <section class="dashboard">
                <h2 class="section-title">区块链概览</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">区块高度</div>
                        <div class="stat-value" id="blockHeight">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">交易总数</div>
                        <div class="stat-value" id="totalTransactionCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">组织数量</div>
                        <div class="stat-value" id="orgCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">链码数量</div>
                        <div class="stat-value" id="chainCodeCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">节点数量</div>
                        <div class="stat-value" id="nodeCount">0</div>
                    </div>
                </div>
                
                <div class="blocks-section">
                    <div class="blocks-header">
                        <h2 class="section-title">最新区块</h2>
                        <div class="pagination">
                            <button id="prevPage" disabled>上一页</button>
                            <span id="pageInfo">第 1 页</span>
                            <button id="nextPage">下一页</button>
                        </div>
                    </div>
                    
                    <table class="blocks-table">
                        <thead>
                            <tr>
                                <th>区块高度</th>
                                <th>区块哈希</th>
                                <th>交易数量</th>
                                <th>时间戳</th>
                                <th>大小</th>
                            </tr>
                        </thead>
                        <tbody id="blocksTableBody">
                            <!-- 区块数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <footer>
            <div class="container">
                <p>区块链浏览器 &copy; 2023 - 基于Hyperledger Fabric</p>
            </div>
        </footer>
    </div>

    <!-- 区块详情页面（初始隐藏） -->
    <div id="block-detail-page" style="display: none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">⛓️</span>
                        <span>区块详情</span>
                    </div>
                    <nav>
                        <ul>
                            <li><a href="#" id="back-to-home">返回首页</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </header>

        <main class="container">
            <button class="back-button" id="back-button">
                ← 返回区块列表
            </button>
            
            <div class="block-detail">
                <h2 class="section-title">区块信息</h2>
                
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-title">区块高度</div>
                        <div class="detail-value" id="detail-blockNumber">0</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">区块哈希</div>
                        <div class="detail-value">
                            <span class="hash-value" id="detail-blockHash">0x0000...</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">前一个区块哈希</div>
                        <div class="detail-value">
                            <span class="hash-value" id="detail-previousHash">0x0000...</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">Merkle根</div>
                        <div class="detail-value">
                            <span class="hash-value" id="detail-dataHash">0x0000...</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">交易数量</div>
                        <div class="detail-value" id="detail-txCount">0</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">区块大小</div>
                        <div class="detail-value" id="detail-blockSize">0 bytes</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">时间戳</div>
                        <div class="detail-value" id="detail-timestamp">-</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-title">通道ID</div>
                        <div class="detail-value" id="detail-channelId">-</div>
                    </div>
                </div>
                
                <div class="transactions-section">
                    <h2 class="section-title">交易列表</h2>
                    <ul class="transaction-list" id="transactionList">
                        <!-- 交易数据将通过JavaScript动态加载 -->
                    </ul>
                </div>
            </div>
        </main>

        <footer>
            <div class="container">
                <p>区块链浏览器 &copy; 2023 - 基于Hyperledger Fabric</p>
            </div>
        </footer>
    </div>

    <script>
        // 全局变量
        let currentPage = 0;
        const pageSize = 10;
        let blockHeight = 0;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载概览数据
            loadOverviewData();
            
            // 加载区块列表
            loadBlocks(currentPage, pageSize);
            
            // 绑定事件监听器
            document.getElementById('prevPage').addEventListener('click', function() {
                if (currentPage > 0) {
                    currentPage--;
                    loadBlocks(currentPage, pageSize);
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', function() {
                if ((currentPage + 1) * pageSize < blockHeight) {
                    currentPage++;
                    loadBlocks(currentPage, pageSize);
                }
            });
            
            document.getElementById('back-button').addEventListener('click', function() {
                showHomePage();
            });
            
            document.getElementById('back-to-home').addEventListener('click', function(e) {
                e.preventDefault();
                showHomePage();
            });
        });

        // 加载概览数据
        async function loadOverviewData() {
            try {
                const response = await fetch('/valuechain');
                const data = await response.json();
                
                document.getElementById('blockHeight').textContent = data.blockHeight;
                document.getElementById('totalTransactionCount').textContent = data.totalTransactionCount;
                document.getElementById('orgCount').textContent = data.orgCount;
                document.getElementById('chainCodeCount').textContent = data.chainCodeCount;
                document.getElementById('nodeCount').textContent = data.nodeCount;
                
                blockHeight = data.blockHeight;
            } catch (error) {
                console.error('加载概览数据失败:', error);
            }
        }

        // 加载区块列表
        async function loadBlocks(pageNum, pageSize) {
            try {
                const response = await fetch(`/valuechain/getBlockByPage?pageNum=${pageNum}&pageSize=${pageSize}`);
                const blocks = await response.json();
                
                const tableBody = document.getElementById('blocksTableBody');
                tableBody.innerHTML = '';
                
                blocks.forEach(block => {
                    const row = document.createElement('tr');
                    row.className = 'block-row';
                    row.setAttribute('data-block-num', block.blockNumber);
                    
                    // 格式化时间戳
                    const timestamp = new Date(block.timestamp).toLocaleString();
                    
                    row.innerHTML = `
                        <td class="block-number">${block.blockNumber}</td>
                        <td class="block-hash" title="${block.blockHash}">${block.blockHash.substring(0, 20)}...</td>
                        <td><span class="tx-count">${block.txCount}</span></td>
                        <td class="timestamp">${timestamp}</td>
                        <td>${formatBytes(block.blockSize)}</td>
                    `;
                    
                    // 添加点击事件
                    row.addEventListener('click', function() {
                        showBlockDetail(block.blockNumber);
                    });
                    
                    tableBody.appendChild(row);
                });
                
                // 更新分页信息
                document.getElementById('pageInfo').textContent = `第 ${pageNum + 1} 页`;
                document.getElementById('prevPage').disabled = pageNum === 0;
                document.getElementById('nextPage').disabled = (pageNum + 1) * pageSize >= blockHeight;
            } catch (error) {
                console.error('加载区块列表失败:', error);
            }
        }

        // 显示区块详情
        async function showBlockDetail(blockNum) {
            try {
                const response = await fetch(`/valuechain/getBlockByNum?blockNum=${blockNum}`);
                const block = await response.json();
                
                // 填充区块详情数据
                document.getElementById('detail-blockNumber').textContent = block.blockNumber;
                document.getElementById('detail-blockHash').textContent = block.blockHash;
                document.getElementById('detail-previousHash').textContent = block.previousHash;
                // [修改] 后端返回 dataHash
                document.getElementById('detail-dataHash').textContent = block.dataHash;
                document.getElementById('detail-txCount').textContent = block.txCount;
                document.getElementById('detail-blockSize').textContent = formatBytes(block.blockSize);
                document.getElementById('detail-timestamp').textContent = new Date(block.timestamp).toLocaleString();
                // [修改] 后端返回 channelId
                document.getElementById('detail-channelId').textContent = block.channelId;
                
                // 填充交易列表
                const transactionList = document.getElementById('transactionList');
                transactionList.innerHTML = '';
                
                // [修改] 后端返回 txIds
                if (block.txIds && block.txIds.length > 0) {
                    block.txIds.forEach(txId => {
                        const li = document.createElement('li');
                        li.className = 'transaction-item';
                        li.innerHTML = `<span class="transaction-id">${txId}</span>`;
                        transactionList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.className = 'transaction-item';
                    li.textContent = '此区块没有交易';
                    transactionList.appendChild(li);
                }
                
                // 显示详情页面
                showBlockDetailPage();
            } catch (error) {
                console.error('加载区块详情失败:', error);
            }
        }

        // 显示主页
        function showHomePage() {
            document.getElementById('home-page').style.display = 'block';
            document.getElementById('block-detail-page').style.display = 'none';
        }

        // 显示区块详情页面
        function showBlockDetailPage() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('block-detail-page').style.display = 'block';
        }

        // 格式化字节大小
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>